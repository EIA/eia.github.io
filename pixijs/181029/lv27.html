<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width">
	<title>lv27</title>

	<!-- <script src="//cdnjs.cloudflare.com/ajax/libs/pixi.js/4.2.2/pixi.min.js"></script> -->
	<!-- <script src="//cdnjs.cloudflare.com/ajax/libs/pixi.js/4.3.5/pixi.min.js"></script> -->
	<script src="//cdnjs.cloudflare.com/ajax/libs/pixi.js/4.5.4/pixi.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/2.0.2/TweenMax.min.js"></script>
	<script src="//code.jquery.com/jquery-2.2.4.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.3/dat.gui.min.js"></script>
	

	<style>
			@import url(http://fonts.googleapis.com/earlyaccess/notosanstc.css);
			html, body{
				font-family: 'Noto Sans TC', 'Microsoft JhengHei', Tahoma, Verdana, Arial, Helvetica, sans-serif; /* 'Noto Sans TC',  */
				font-weight: 300;
				margin: 0;
				overflow: hidden;
			}
			.info{
				margin: 5px;
				padding: 5px 10px;
				color: #fff;
				position: fixed;
				left: 0;
				top: 0;
				font-size: 12px;
				z-index: 3;
				background-color: rgba(0, 0, 0, 0.3);
			}
	
		</style>
	
</head>
<body>
	
	<div class="info"></div>


	<script>


		var device;
		if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
			device = 'mobile';
		} else {
			device = 'pc';
		}

		////////////////////////////////////////////////////////////////////////////////////////

		var app, bunny, background, loadedShaderData, filter;
		var bg1, bg2, bg3, bg4;
		var bgs = [];
		var touch_data;
		var bgLock = false;
		var tl;
		var tmpBg = currentBg = 0;
		var bgDir = ""
		var gui, effectController;
		var mouseX, mouseY;
		var otString = '', tlString = '';
		var uX = 0, uD = 0;
		var PIC_WIDTH = 1920, PIC_HEIGHT = 1080;
		// var PIC_WIDTH = 300, PIC_HEIGHT = 300;

		//////////////////////////////////////
				
		// app = new PIXI.Application(800, 600, {backgroundColor : 0x1099bb});
		// app = new PIXI.Application(1024, 768, {backgroundColor : 0xdddddd});
		app = new PIXI.Application(1024, 768, {backgroundColor : 0x0});
		document.body.appendChild(app.view);



		//////////////////////////////////////

		background = new PIXI.Container();
		background.width = PIC_WIDTH;
		background.height = PIC_HEIGHT;
		// background.anchor.set(0.5);
		// background.x = app.renderer.width / 2;
		// background.y = app.renderer.height / 2;
		app.stage.addChild(background);

		//////////////////////////////////////

		bg1 = PIXI.Sprite.fromImage('images/1.jpg');
		bg2 = PIXI.Sprite.fromImage('images/2.jpg');
		bg3 = PIXI.Sprite.fromImage('images/3.jpg');
		bg4 = PIXI.Sprite.fromImage('images/4.jpg');
		bgs = [bg1, bg2, bg3, bg4];

		/*
		var testBg = PIXI.Sprite.fromImage('assets/UV_Grid_Sm_300.jpg');
		bgs = [testBg];
		*/
		

		bg1.width = bg2.width = bg3.width = bg4.width = PIC_WIDTH;
		bg1.height = bg2.height = bg3.height = bg4.height = PIC_HEIGHT;
		for(var i=0; i<bgs.length; i++){
			TweenMax.set(bgs[i], {alpha:0});
			background.addChild(bgs[i]);
		}

		//////////////////////////////////////

		bunny = PIXI.Sprite.fromImage('assets/basics/bunny.png');

		bunny.anchor.set(0.5);
		bunny.x = app.screen.width / 2;
		bunny.y = app.screen.height / 2;
		app.stage.addChild(bunny);

		app.stop();





		PIXI.loader.add('shader', 'lv27.frag').load(onLoaded);

		filter;
		loadedShaderData = '';

		var tCount = 0;

		function onLoaded (loader,res) {

		    loadedShaderData = res.shader.data;

			//filter = new PIXI.Filter(null, loadedShaderData, null);

			var uniforms = {
								dimensions: { type: 'v2', value: [569, 412] },
								uX: { type: 'float', value: 0 },
								uD: { type: 'float', value: 0 },
								uShowUV: { type: 'bool', value: effectController.ShowUV },
								uTestMask: { type: 'bool', value: effectController.TestMask },
								uTestShap: { type: 'bool', value: effectController.TestShap },
								mappedMatrix: { type: 'mat3', value: new PIXI.Matrix()},
							};
			filter = new PIXI.Filter( null, loadedShaderData, uniforms );
			filter.apply = function(filterManager, input, output)
			{
				tCount ++;
				this.uniforms.dimensions[0] = input.sourceFrame.width;
				this.uniforms.dimensions[1] = input.sourceFrame.height;
				this.uniforms.uX = uX;
				this.uniforms.uD = uD;
				this.uniforms.mappedMatrix = filterManager.calculateNormalizedScreenSpaceMatrix( this.uniforms.mappedMatrix );

				/*
				if(tCount%1000 == 1){
					console.log(this);
					console.log(this.uniforms);
					console.log(this.uniforms.mappedMatrix);
					console.log(filterManager);
					console.log(filterManager.calculateNormalizedScreenSpaceMatrix);
				}
				*/

				filterManager.applyFilter(this, input, output);
			}










		    background.filters = [filter];
		    // app.stage.filters = [filter];
		    // bunny.filters = [filter];
		    
		    filter.padding = 0;


			startApp();
		}



		app.ticker.add(function(delta) {
		    bunny.rotation += 0.1 * delta;
		    // console.log(delta);

			var tmpUVX, tmpUVY;
			var tmpUVX2, tmpUVY2;

			if(device == 'pc'){
				mouseX = app.renderer.plugins.interaction.mouse.global.x;
				mouseY = app.renderer.plugins.interaction.mouse.global.y;
			}else{
				if(touch_data){
					console.log(touch_data);
					console.log(touch_data.data.getLocalPosition(app.stage));
					console.log(touch_data.data.global.x);
					console.log(touch_data.data.global.y);

					mouseX = touch_data.data.global.x;
					mouseY = touch_data.data.global.y;
				}else{
				}
			}


			if(mouseX < -50 ){
				mouseX = -50;
			}else if(mouseX > app.screen.width + 50){
				mouseX = app.screen.width + 50;
			}
			if(mouseY < -50 ){
				mouseY = -50;
			}else if(mouseY > app.screen.height + 50){
				mouseY = app.screen.height + 50;
			}

			// bunny.x += (mouseX - bunny.x) * 0.0625;
			// bunny.y += (mouseY - bunny.y) * 0.0625;
			bunny.x += (mouseX - bunny.x) * 0.125;
			bunny.y += (mouseY - bunny.y) * 0.125;

			otString = '';
			otString += tlString;
			otString += '<br>';

			otString += 'window.innerWidth: ' + window.innerWidth+', window.innerHeight: '+ window.innerHeight;
			otString += '<br>';
			otString += 'bg.x: ' + background.x+', bg.y: '+ background.y;
			otString += '<br>';
			otString += 'bg.width: ' + background.width+', bg.height: '+ background.height;
			otString += '<br>';
			/*
			otString += 'uX: ' + mouseX / app.screen.width;
			otString += '<br>';
			otString += 'bunny.x: ' + Math.round(bunny.x);
			otString += '<br>';
			otString += 'bunny.y: ' + Math.round(bunny.y);
			otString += '<br>';
			otString += 'x dist: ' + Math.round(mouseX - bunny.x);
			otString += '<br>';
			otString += 'x dist percent: ' + (Math.round((mouseX - bunny.x) / app.screen.width * 100)) + ' %';
			otString += '<br>';
			otString += 'y dist: ' + Math.round(mouseY - bunny.y);
			otString += '<br>';
			otString += 'y dist percent: ' + (Math.round((mouseY - bunny.y) / app.screen.height * 100)) + ' %';
			otString += '<br>';

			otString += '--<br>';
			*/

			tmpUVX = mouseX - background.x;
			tmpUVY = mouseY - background.y;
			tmpUVX2 = bunny.x - background.x;
			tmpUVY2 = bunny.y - background.y;

			otString += 'uv x Mouse: ' + tmpUVX;
			otString += '<br>';
			otString += 'uv y Mouse: ' + tmpUVY;
			otString += '<br>';

			otString += 'uv x dist percent: ' + (Math.round((tmpUVX - background.x) / background.width * 100)) + ' %';
			otString += '<br>';
			otString += 'uv y dist percent: ' + (Math.round((tmpUVY - background.y) / background.height * 100)) + ' %';
			otString += '<br>';


			// v1 //
			// filter.uniforms.uX = 0.5;

			// v2 //
			// filter.uniforms.uX = tmpUVX / app.screen.width;

			// v3 //
			// filter.uniforms.uX = (tmpUVX - background.x) / background.width;
			// filter.uniforms.uD = (tmpUVX - bunny.x) / app.screen.width;

			// v4 //
			// uX = (tmpUVX2 - background.x) / background.width;
			// uD = (tmpUVX - bunny.x) / background.width;

			// v5 //
			uX = bunny.x / app.screen.width;
			uD = (mouseX - bunny.x) / app.screen.width;
			
			otString += '<br>';
			otString += 'uX: ' + uX;
			otString += '<br>';
			otString += 'uD: ' + uD;
			$('.info').html(otString);






		});


		function startApp(){
		    app.start();
			bgHandler();
			app.stage.interactive = true;

			if(device == "pc"){
			}else{
				mouseX = app.screen.width*0.5;
				mouseY = app.screen.height*0.5;
			}
				

			// PC
			app.stage.on('click', onClick);

			// MOBILE
			// app.stage.on('pointerdown', onDragStart);
			app.stage.on('touchstart', onDragStart);
			app.stage.on('touchend', onDragEnd);
			app.stage.on('touchendoutside', onDragEnd);
			app.stage.on('touchmove', onDragMove);

			// sprite.on('pointerdown', onClick); // Pointers normalize touch and mouse
			// sprite.on('click', onClick); // mouse-only
			// sprite.on('tap', onClick); // touch-only

			tlString = '[UNLOCK]';

		}

		// PC //
		function onClick(){
			console.log("pc click: [x: "+mouseX+", y:"+mouseY+"]");
			if(mouseX>=app.screen.width*0.5){
				nextBg();
			}else{
				prevBg();
			}
		}

		// MOBILE //
		function onDragStart(evt){
			touch_data = evt;
			bunny.x = mouseX = touch_data.data.global.x;
			bunny.y = mouseY = touch_data.data.global.y;
		}
		function onDragEnd(){
			touch_data = null;
		}
		function onDragMove(){
			if(touch_data){
				if(uD >0.3){
					nextBg();
					touch_data = null;
				}else if(uD <-0.3){
					prevBg();
					touch_data = null;
				}
			}
		}


		function nextBg(){
			if(	bgLock == true ){ return; };
			tmpBg = currentBg;
			currentBg ++;
			bgDir = "NEXT";
			if(currentBg > bgs.length -1){ currentBg = 0; };
			bgHandler();
		}
		function prevBg(){
			if(	bgLock == true ){ return; };
			tmpBg = currentBg;
			currentBg --;
			bgDir = "PREV";
			if(currentBg < 0 ){ currentBg = bgs.length -1; };
			bgHandler();
		}
		function bgHandler(){
			console.log("tmpBg: "+tmpBg+" currentBg: "+currentBg);
			tl = new TimelineMax({onStart: bgStart, onComplete:bgEnd});
			//
			var dirX = 0;
			if(bgDir == "NEXT"){
				dirX = 50;
			}else if(bgDir == "PREV"){
				dirX = -50;
			}

			tl.clear();
			tl.to(bgs[tmpBg], 1, {alpha:0, x: dirX, ease:Strong.easeOut}, "start");
			tl.set(bgs[currentBg], {x: dirX * -1}, "start");
			tl.to(bgs[currentBg], 1, {alpha:1, x:0, ease:Strong.easeOut}, "start+=0.3");
	

		}
		function bgStart(){
			console.log('bgStart');
			tlString = '[LOCK]';
			bgLock = true;
		}
		function bgEnd(){
			console.log('bgEnd');
			tlString = '[UNLOCK]';
			bgLock = false;
		}

		///////////////////////////////////////////

		window.onresize = function (event){
			var w = window.innerWidth;
			var h = window.innerHeight;

			app.view.style.width = w + "px";
			app.view.style.height = h + "px";
			app.renderer.resize(w,h);



			var scalePercent;
			if(app.screen.width / app.screen.height > PIC_WIDTH / PIC_HEIGHT ){
				// scalePercent = app.screen.width / PIC_WIDTH; // cover
				scalePercent = app.screen.height / PIC_HEIGHT; // contain
			}else{
				// scalePercent = app.screen.height / PIC_HEIGHT; // cover
				scalePercent = app.screen.width / PIC_WIDTH; // contain
			}


			background.width = Math.round(PIC_WIDTH * scalePercent);
			background.height = Math.round(PIC_HEIGHT * scalePercent);

			background.x = Math.round((background.width - app.screen.width) * -.5);
			background.y = Math.round((background.height - app.screen.height) * -.5);

			background.filterArea = app.screen;

			// var tmpResolution = [app.screen.width, app.screen.height];
			// if(filter){ filter.uniforms.uResolution = tmpResolution; };

		};
		onresize();


		///////////////////////////////////////////

		gui = new dat.GUI();
		effectController = {
			ShowUV: true,
			TestMask: false,
			TestShap: false,
			Filter: true
		};

		// gui.add( effectController, "X", 0, 1, 0.01 ).onChange( xChanger );
		gui.add( effectController, "ShowUV" ).onChange( showUVchange );
		gui.add( effectController, "TestMask" ).onChange( testMaskChange );
		gui.add( effectController, "TestShap" ).onChange( testShapChange );
		gui.add( effectController, "Filter" ).onChange( filterChange );

		///////////////////////////////////////////

		function showUVchange(){
			console.log('showUVchange: ' + effectController.ShowUV);
			filter.uniforms.uShowUV = effectController.ShowUV;
		}

		function testMaskChange(){
			console.log('testMaskChange: ' + effectController.TestMask);
			filter.uniforms.uTestMask = effectController.TestMask;
		}

		function testShapChange(){
			console.log('testShapChange: ' + effectController.TestShap);
			filter.uniforms.uTestShap = effectController.TestShap;
		}

		function filterChange(){
			background.filters = effectController.Filter?[filter]:[];			
		}
		

	</script>
</body>
</html>